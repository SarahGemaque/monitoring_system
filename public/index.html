<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }
        .dashboard {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        #grafico {
            max-width: 90vw;
            margin-bottom: 20px;
            width: 100%;
            height: 300px;
        }
        #radar-container {
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
            height: 400px;
        }
        .container {
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ccc;
            padding: 15px;
            width: 240px;
            text-align: center;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .container img {
            width: 120px;
            height: 140px;
            object-fit: cover;
            border-radius: 5px;
        }
        .info {
            margin-top: 10px;
            font-size: 14px;
            text-align: left;
            width: 100%;
        }
        .info p {
            margin: 5px 0;
        }
        @media (max-width: 768px) {
            #grafico {
                height: 250px;
            }
            #radar-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <canvas id="grafico"></canvas>
        <div id="radar-container"></div>
        <div class="container" id="ultimoAcesso">
            <img src="" id="foto" alt="Foto do usuário" />
            <div class="info">
                <p><strong>Nome:</strong> <span id="nome"></span></p>
                <p><strong>Id:</strong> <span id="id"></span></p>
                <p><strong>Status:</strong> <span id="status"></span></p>
                <p><strong>Data:</strong> <span id="data"></span></p>
                <p><strong>Hora:</strong> <span id="hora"></span></p>
            </div>
        </div>
    </div>

    <script>
        async function getData() {
            try {
                const response = await fetch('/api/dados');
                if (!response.ok) throw new Error(response.statusText);
                return await response.json();
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                return [];
            }
        }

        async function renderChart() {
            const data = await getData();
            if (!data.length) {
                console.log("Nenhum dado disponível para exibição.");
                return;
            }

            const labels = data.map(item => new Date(item.data_hora).toLocaleString());
            const temperatura = data.map(item => item.temperatura);
            const umidade = data.map(item => item.umidade);
            const lux = data.map(item => item.lux);

            const ctx = document.getElementById('grafico').getContext('2d');

            if (window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Temperatura (°C)',
                            data: temperatura,
                            borderColor: 'rgb(255, 99, 132)',
                            fill: false,
                            tension: 0.3,
                        },
                        {
                            label: 'Umidade (%)',
                            data: umidade,
                            borderColor: 'rgb(54, 162, 235)',
                            fill: false,
                            tension: 0.3,
                        },
                        {
                            label: 'Lux',
                            data: lux,
                            borderColor: 'rgb(75, 192, 192)',
                            fill: false,
                            tension: 0.3,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    stacked: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Data/Hora'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Valor'
                            },
                            beginAtZero: true,
                        }
                    }
                }
            });
        }

        const sketchRadar = (p) => {
            let angle = 0;
            let distance = 0;

            p.setup = () => {
                const canvas = p.createCanvas(600, 400);
                canvas.parent('radar-container');
                p.angleMode(p.DEGREES);
            };

            p.draw = () => {
                p.background(0);
                p.translate(p.width / 2, p.height);
                p.stroke(98, 245, 31);
                p.noFill();

                for (let r = 200; r <= 600; r += 200) {
                    p.arc(0, 0, r, r, 180, 360);
                }

                for (let a = 0; a <= 180; a += 30) {
                    p.line(0, 0, -300 * p.cos(a), -300 * p.sin(a));
                }

                p.stroke(30, 250, 60);
                p.line(0, 0, -300 * p.cos(angle), -300 * p.sin(angle));

                if (distance < 300) {
                    p.stroke(255, 0, 0);
                    p.ellipse(-distance * p.cos(angle), -distance * p.sin(angle), 10, 10);
                }
            };

            const socket = io();
            socket.on('radar-data', (data) => {
                angle = data.angle;
                distance = data.distance;
            });
        };

        function carregarUltimoAcesso() {
            fetch('/ultimo-acesso')
                .then(response => response.json())
                .then(data => {
                    if (data.mensagem) {
                        alert(data.mensagem);
                        return;
                    }
                    document.getElementById('nome').textContent = data.nome;
                    document.getElementById('id').textContent = data.id;
                    document.getElementById('status').textContent = data.status;
                    document.getElementById('data').textContent = data.data;
                    document.getElementById('hora').textContent = data.hora;

                    // Se não houver foto, define um placeholder
                    const fotoEl = document.getElementById('foto');
                    if(data.foto) {
                        fotoEl.src = `/fotos/${encodeURIComponent(data.foto)}`;
                    } else {
                        fotoEl.src = 'https://via.placeholder.com/120x140?text=Sem+Foto';
                    }
                })
                .catch(error => console.error('Erro ao carregar o último acesso:', error));
        }

        window.onload = () => {
            renderChart();
            new p5(sketchRadar);
            carregarUltimoAcesso();
            setInterval(renderChart, 60000);
        };
    </script>
</body>
</html>
